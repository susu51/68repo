import React, { useState, useEffect } from 'react';
import { Button } from "./ui/button";
import { Card, CardContent } from "./ui/card";
import { Badge } from "./ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "./ui/select";
import toast from 'react-hot-toast';

export const LocationControls = ({ 
  onLocationChange, 
  currentLocation = null,
  locationMode = 'city',
  onLocationModeChange 
}) => {
  const [locationLoading, setLocationLoading] = useState(false);
  const [userLocation, setUserLocation] = useState(null);
  const [selectedCity, setSelectedCity] = useState('ƒ∞stanbul');
  const [locationError, setLocationError] = useState(null);

  const turkishCities = [
    "Adana", "Adƒ±yaman", "Afyonkarahisar", "Aƒürƒ±", "Amasya", "Ankara", "Antalya", 
    "Artvin", "Aydƒ±n", "Balƒ±kesir", "Bilecik", "Bing√∂l", "Bitlis", "Bolu", 
    "Burdur", "Bursa", "√áanakkale", "√áankƒ±rƒ±", "√áorum", "Denizli", "Diyarbakƒ±r", 
    "Edirne", "Elazƒ±ƒü", "Erzincan", "Erzurum", "Eski≈üehir", "Gaziantep", 
    "Giresun", "G√ºm√º≈ühane", "Hakk√¢ri", "Hatay", "Isparta", "Mersin", "ƒ∞stanbul", 
    "ƒ∞zmir", "Kars", "Kastamonu", "Kayseri", "Kƒ±rklareli", "Kƒ±r≈üehir", "Kocaeli", 
    "Konya", "K√ºtahya", "Malatya", "Manisa", "Kahramanmara≈ü", "Mardin", "Muƒüla", 
    "Mu≈ü", "Nev≈üehir", "Niƒüde", "Ordu", "Rize", "Sakarya", "Samsun", "Siirt", 
    "Sinop", "Sivas", "Tekirdaƒü", "Tokat", "Trabzon", "Tunceli", "≈ûanlƒ±urfa", 
    "U≈üak", "Van", "Yozgat", "Zonguldak", "Aksaray", "Bayburt", "Karaman", 
    "Kƒ±rƒ±kkale", "Batman", "≈ûƒ±rnak", "Bartƒ±n", "Ardahan", "Iƒüdƒ±r", "Yalova", 
    "Karab√ºk", "Kilis", "Osmaniye", "D√ºzce"
  ];

  // Get user's current location using browser geolocation
  const getCurrentLocation = () => {
    if (!navigator.geolocation) {
      toast.error('Tarayƒ±cƒ±nƒ±z konum servislerini desteklemiyor');
      return;
    }

    setLocationLoading(true);
    setLocationError(null);

    navigator.geolocation.getCurrentPosition(
      async (position) => {
        const { latitude, longitude } = position.coords;
        
        try {
          // Reverse geocoding to get city/district info
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=10&addressdetails=1`
          );
          
          if (response.ok) {
            const data = await response.json();
            const address = data.address || {};
            
            const locationInfo = {
              latitude,
              longitude,
              city: address.city || address.state || address.county || 'Bilinmeyen ≈ûehir',
              district: address.town || address.suburb || address.neighbourhood || null,
              address: data.display_name || 'Konum bilgisi alƒ±namadƒ±'
            };
            
            setUserLocation(locationInfo);
            onLocationChange(locationInfo);
            toast.success(`üìç Konumunuz: ${locationInfo.city}${locationInfo.district ? `, ${locationInfo.district}` : ''}`);
          } else {
            throw new Error('Konum bilgisi alƒ±namadƒ±');
          }
        } catch (error) {
          console.error('Reverse geocoding error:', error);
          const basicLocation = {
            latitude,
            longitude,
            city: 'Konum Tespit Edildi',
            district: null,
            address: `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`
          };
          
          setUserLocation(basicLocation);
          onLocationChange(basicLocation);
          toast.success('üìç Konumunuz tespit edildi');
        }
        
        setLocationLoading(false);
      },
      (error) => {
        setLocationLoading(false);
        let errorMessage = 'Konum alƒ±namadƒ±';
        
        switch(error.code) {
          case error.PERMISSION_DENIED:
            errorMessage = 'Konum izni reddedildi. L√ºtfen tarayƒ±cƒ± ayarlarƒ±ndan konum izni verin.';
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage = 'Konum bilgisi kullanƒ±lamƒ±yor.';
            break;
          case error.TIMEOUT:
            errorMessage = 'Konum tespiti zaman a≈üƒ±mƒ±na uƒüradƒ±.';
            break;
        }
        
        setLocationError(errorMessage);
        toast.error(errorMessage);
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 300000 // 5 minutes
      }
    );
  };

  // Handle city selection
  const handleCityChange = (city) => {
    setSelectedCity(city);
    const cityLocation = {
      city,
      district: null,
      latitude: null,
      longitude: null,
      address: city
    };
    onLocationChange(cityLocation);
  };

  // Handle location mode change
  const handleModeChange = (mode) => {
    onLocationModeChange(mode);
    
    if (mode === 'nearest' && !userLocation) {
      getCurrentLocation();
    } else if (mode === 'city') {
      handleCityChange(selectedCity);
    }
  };

  return (
    <Card className="mb-6">
      <CardContent className="p-4">
        <div className="flex flex-col space-y-4">
          {/* Mode Selection */}
          <div className="flex flex-col sm:flex-row gap-2">
            <Button
              variant={locationMode === 'nearest' ? 'default' : 'outline'}
              onClick={() => handleModeChange('nearest')}
              disabled={locationLoading}
              className="flex-1 flex items-center justify-center space-x-2"
            >
              <span className="text-lg">üìç</span>
              <span>En Yakƒ±nƒ±m</span>
              {locationMode === 'nearest' && userLocation && (
                <Badge variant="secondary" className="ml-2">
                  {userLocation.city}
                </Badge>
              )}
            </Button>
            
            <Button
              variant={locationMode === 'city' ? 'default' : 'outline'}
              onClick={() => handleModeChange('city')}
              className="flex-1 flex items-center justify-center space-x-2"
            >
              <span className="text-lg">üèôÔ∏è</span>
              <span>≈ûehir Geneli</span>
              {locationMode === 'city' && (
                <Badge variant="secondary" className="ml-2">
                  {selectedCity}
                </Badge>
              )}
            </Button>
          </div>

          {/* Location Details */}
          <div className="bg-gray-50 rounded-lg p-3">
            {locationMode === 'nearest' && (
              <div className="space-y-2">
                {locationLoading ? (
                  <div className="flex items-center space-x-2">
                    <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-orange-600"></div>
                    <span className="text-sm text-gray-600">Konumunuz tespit ediliyor...</span>
                  </div>
                ) : userLocation ? (
                  <div className="space-y-1">
                    <div className="flex items-center space-x-2">
                      <span className="text-green-600">‚úÖ</span>
                      <span className="text-sm font-medium">
                        {userLocation.city}{userLocation.district && `, ${userLocation.district}`}
                      </span>
                    </div>
                    <p className="text-xs text-gray-500 ml-6">
                      Mesafe √∂ncelikli sƒ±ralama aktif
                    </p>
                  </div>
                ) : locationError ? (
                  <div className="space-y-2">
                    <div className="flex items-center space-x-2">
                      <span className="text-red-600">‚ùå</span>
                      <span className="text-sm text-red-600">Konum alƒ±namadƒ±</span>
                    </div>
                    <p className="text-xs text-gray-500 ml-6">{locationError}</p>
                    <Button 
                      size="sm" 
                      variant="outline"
                      onClick={getCurrentLocation}
                      className="ml-6 mt-2"
                    >
                      üîÑ Tekrar Dene
                    </Button>
                  </div>
                ) : (
                  <div className="space-y-2">
                    <div className="flex items-center space-x-2">
                      <span className="text-blue-600">üìç</span>
                      <span className="text-sm">Konumunuzu tespit etmek i√ßin tƒ±klayƒ±n</span>
                    </div>
                    <Button 
                      size="sm" 
                      onClick={getCurrentLocation}
                      className="ml-6 bg-orange-600 hover:bg-orange-700"
                    >
                      üìç ≈ûu Anki Konumum
                    </Button>
                  </div>
                )}
              </div>
            )}

            {locationMode === 'city' && (
              <div className="space-y-2">
                <div className="flex items-center space-x-2">
                  <span className="text-blue-600">üèôÔ∏è</span>
                  <span className="text-sm font-medium">≈ûehir se√ßimi</span>
                </div>
                <Select value={selectedCity} onValueChange={handleCityChange}>
                  <SelectTrigger className="ml-6 max-w-xs">
                    <SelectValue placeholder="≈ûehir se√ßin" />
                  </SelectTrigger>
                  <SelectContent>
                    {turkishCities.map((city) => (
                      <SelectItem key={city} value={city}>
                        {city}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
                <p className="text-xs text-gray-500 ml-6">
                  Se√ßilen ≈üehirdeki t√ºm aktif restoranlar g√∂steriliyor
                </p>
              </div>
            )}
          </div>

          {/* Location Stats */}
          <div className="flex justify-between items-center text-xs text-gray-500 border-t pt-2">
            <span>
              {locationMode === 'nearest' ? 'üìç Mesafeye g√∂re sƒ±ralƒ±' : 'üèôÔ∏è ≈ûehir geneli'}
            </span>
            <span>
              {currentLocation && (
                locationMode === 'nearest' && userLocation
                  ? `${userLocation.latitude?.toFixed(4)}, ${userLocation.longitude?.toFixed(4)}`
                  : `üìç ${selectedCity}`
              )}
            </span>
          </div>
        </div>
      </CardContent>
    </Card>
  );
};

export default LocationControls;